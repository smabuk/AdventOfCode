@using Microsoft.Extensions.Options
@implements IDisposable
@attribute [ExcludeFromInteractiveRouting]
@inject SessionState Session
@inject AocJsInterop aocJS
@inject IOptions<AocSettings> aocSettings

<p class="answer">
	@ChildContent
	<pre><code><span>Your puzzle answer is </span></code><code @ref="_codeElement">@PuzzleAnswerDisplay</code></pre>
	<span>
		<button type="button"
				class="btn btn-primary"
				disabled="@(PuzzleAnswerDisplay.StartsWith("*") && PuzzleAnswerDisplay.EndsWith("*"))"
				title="Copy the answer to the clipboard."
				@onclick="CopyTextToClipboard">
			Copy <i class="bi-clipboard" aria-hidden="true"></i>
		</button>
	</span>
	<span>
		<a class="btn btn-primary"
		   href="@($"{aocSettings.Value.Site}{Year}/day/{Day}")"
		   title="Open a new page and navigate to the AdventOfCode site to enter the answer."
		   target="_blank">
			Jump <i class="bi-box-arrow-up-right" aria-hidden="true"></i>
		</a>
	</span>
</p>
<div>
	<Visualiser @ref="_visualiser" Year="Year" Day="Day" ProblemNo="ProblemNo" />
</div>

@code {
	const string SOLVING = "** Solving... **";

	[Parameter] public int Year { get; set; }
	[Parameter] public int Day { get; set; }
	[Parameter] public int ProblemNo { get; set; }
	[Parameter] public RenderFragment? ChildContent { get; set; }

	[PersistentState(AllowUpdates = true)]
	public string? PuzzleAnswer { get; set; }

	string PuzzleAnswerDisplay => PuzzleAnswer is null ? "" : PuzzleAnswer;

	Visualiser _visualiser = null!;
	private ElementReference _codeElement;

	private string? _lastCalculatedInput;
	private int _lastYear;
	private int _lastDay;
	private int _lastProblemNo;


	protected override void OnInitialized()
	{
		Session.OnProblemInputChange -= DataHasChanged;
		Session.OnProblemInputChange += DataHasChanged;
	}

	protected override void OnParametersSet()
	{
		// Check if Year, Day, or ProblemNo have actually changed
		if (_lastYear != Year || _lastDay != Day || _lastProblemNo != ProblemNo) {
			_lastYear = Year;
			_lastDay = Day;
			_lastProblemNo = ProblemNo;

			// Parameters changed - reset everything
			PuzzleAnswer = null;
			_lastCalculatedInput = null;
		}
	}

	protected void DataHasChanged()
	{
		// Get current input hash to detect if it's actually new data
		string? currentInput = Session.HasProblemInput(Year, Day)
			? string.Join("", Session.GetProblemInputAsArray(Year, Day) ?? [])
			: null;

		// Skip if we already calculated for this exact input
		if (currentInput == _lastCalculatedInput && PuzzleAnswer is not null and not SOLVING) {
			return;
		}

		_lastCalculatedInput = currentInput;

		PuzzleAnswer = SOLVING;
		StateHasChanged();

		try {
			if (_visualiser is not null && _visualiser.HasVisualiser) {
				PuzzleAnswer = SolutionRouter.SolveProblem(
					Year,
					Day,
					ProblemNo,
					Session.HasProblemInput(Year, Day) ? Session.GetProblemInputAsArray(Year, Day) : null,
					_visualiser.VisualiseOutput
					);
			} else {
				PuzzleAnswer = SolutionRouter.SolveProblem(Year, Day, ProblemNo,
					Session.HasProblemInput(Year, Day) ? Session.GetProblemInputAsArray(Year, Day) : null);
			}
		}
		catch (Exception ex) {
			PuzzleAnswer = "** EXCEPTION **" + Environment.NewLine + ex?.Message ?? "Exception";
		}

		if (PuzzleAnswer.IndexOf(Environment.NewLine) > 16) {
			PuzzleAnswer = Environment.NewLine + PuzzleAnswer;
		}

		StateHasChanged();
	}

	private async Task CopyTextToClipboard()
	{
		await aocJS.CopyToClipboard(_codeElement);
	}

	public void Dispose()
	{
		Session.OnProblemInputChange -= DataHasChanged;
	}
}